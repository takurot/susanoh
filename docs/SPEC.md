# 機能仕様書 (Target Architecture)：AI駆動型 経済圏防衛ミドルウェア「Susanoh」

## 0. 概要

「Susanoh（スサノヲ）」は、オンラインゲーム経済圏における不正取引（RMT・資金洗浄・Bot活動）を検知・隔離するためのセキュリティミドルウェアです。
本ドキュメントでは、プロダクション運用に向けた**ターゲットアーキテクチャおよび機能要件**を定義します。
（※現行のプロトタイプ実装とは一部異なる箇所が含まれます。）

### 特徴
- **ハイブリッド判定アーキテクチャ**: 高速なルールベース判定（L1）と、LLMによる文脈理解（L2）を組み合わせ、即応性と精度の両立を実現。
- **ハニーポット制御**: 不正疑いのアカウントに対して即座にBANを行うのではなく、「出金のみを停止」する状態へ遷移させることで、業者の活動を泳がせつつ実害を防ぎます。
- **説明可能なAI監査**: Geminiを用いた分析により、判定理由（Reasoning）を自然言語で提示。運営チームの意思決定を支援します。

---

## 1. システムアーキテクチャ (Target)

Susanohは、以下のコンポーネントで構成される分散システムを目指します。

### 1.1 全体構成図

```text
Game Server -> [Load Balancer] -> [API Gateway (FastAPI)]
                                        |
                                        +-> [L1 Screening Engine] <-> [Redis (State/Cache)]
                                        |
                                        +-> [Message Queue (Redis)] -> [L2 Analysis Worker (Celery)] <-> [Gemini API]
                                        |
                                        +-> [Persistence Layer] <-> [PostgreSQL]
```

> **Note**: 現行プロトタイプは単一プロセス・インメモリ構成で動作しており、Redis/PostgreSQL/Celeryは未実装です。

### 1.2 コンポーネント詳細

| コンポーネント | 技術スタック | 役割 |
|---|---|---|
| **API Gateway / L1 Engine** | Python (FastAPI) | イベント受信、入力検証、高速ルール判定、即時レスポンス返却 |
| **State Store** | Redis (Target) | ユーザー状態（ステートマシン）、直近イベントウィンドウの高速管理 |
| **L2 Analysis Worker** | Python (Celery/Arq) | L1でフラグが立ったイベントの非同期詳細分析、LLM呼び出し |
| **AI Provider** | Google Gemini API | 自然言語処理によるチャット解析、複雑な取引パターンの文脈判定 |
| **Primary Database** | PostgreSQL (Target) | ユーザープロファイル、監査ログ、分析結果の永続化 |
| **Dashboard (Frontend)** | React, TypeScript | リアルタイムモニタリング、資金フロー可視化、手動監査インターフェース |

---

## 2. 機能要件

### 2.1 イベント受信・L1スクリーニング

- **エンドポイント**: `POST /api/v1/events`
- **機能**:
  - ゲームサーバーからのイベント（取引、チャット、ログイン等）を受信。
  - Redis上のスライディングウィンドウ（デフォルト5分）を用いて、閾値ベースのルール判定（L1）を実行。
  - **判定レイテンシ**: 50ms以内（99%タイル）

### 2.2 状態管理（ステートマシン）

ユーザーごとに以下のステートを管理し、API経由で現在の状態を提供します。

| ステータス | 説明 | 制限事項 |
|---|---|---|
| `NORMAL` | 通常状態 | なし |
| `RESTRICTED_WITHDRAWAL` | 監視対象（初期） | **出金のみ不可**。入金・プレイは可能。 |
| `UNDER_SURVEILLANCE` | 要監視（AI分析中） | 出金不可。詳細ログ記録モード。 |
| `BANNED` | 凍結 | 全アクション不可。 |

- **遷移ロジック (Target Specification)**:
  - L1検知 → `RESTRICTED_WITHDRAWAL` へ即時遷移
  - L2分析結果（黒/High Risk） → `BANNED` へ遷移
  - L2分析結果（白/Low Risk） → **自動的に `NORMAL` へ復帰**
  - 手動解除 → `NORMAL` へ復帰

### 2.3 L2 詳細分析（非同期）

- **トリガー**: L1での特定ルール検知、または `RESTRICTED_WITHDRAWAL` 状態での追加アクション
- **処理**:
  - 関連する過去イベント、ユーザープロファイル、チャットログを収集。
  - Gemini APIへ構造化プロンプトを送信。
  - **出力**: 不正確率スコア（Risk Score）、判定理由（Reasoning）、証拠イベントID。
- **フォールバック**: LLM API障害時は、安全側に倒して `UNDER_SURVEILLANCE` 状態を維持し、運用者通知を行う。

### 2.4 管理・監査API

- **ユーザー照会**: 特定ユーザーの状態、履歴、関連グラフの取得。
- **手動介入**: アカウントのステート強制変更（誤検知時の解除など）。
- **ダッシュボード用統計**: リアルタイムの検知数、BAN数、スループット等のメトリクス提供。

### 2.5 認証・認可 (Target Requirement)

- **API認証**: ゲームサーバーからのリクエストはAPI Key（Header: `X-API-KEY`）で認証。
- **管理画面認証**: ダッシュボードアクセスはJWTベースの認証（ID/Pass or OAuth2）。
- **権限管理**:
  - `Admin`: 全操作可能
  - `Operator`: 閲覧、手動解除のみ
  - `Viewer`: 閲覧のみ

> **Note**: 現行プロトタイプでは Service API Key（`SUSANOH_API_KEYS` 設定時の `X-API-KEY` 検証）のみ実装済みです。JWT認証とRBACは未実装です。

---

## 3. 非機能要件

### 3.1 パフォーマンス
- **スループット**: 10,000 events/sec（水平スケール時）
- **レイテンシ**: L1判定 < 50ms, L2分析完了 < 5秒

### 3.2 可用性・信頼性
- **SLA**: 99.9%
- **データ整合性**: 監査ログの欠損を許容しない（WAL、定期バックアップ）。
- **障害耐性**: Redis/DB障害時もイベント受信自体は継続し、キューイングまたは縮退運転を行うこと。

### 3.3 セキュリティ
- **通信暗号化**: 全エンドポイントでTLS 1.2以上を強制。
- **データ保護**: PII（個人特定情報）の保存は最小限にし、必要に応じてハッシュ化または暗号化を行う。
- **ログ監査**: 操作ログは全て記録し、改ざん不能な形式で保存する。

---

## 4. 開発・テストツール

プロダクションコードには含めないが、開発およびQAのために以下のツールを提供する。

### 4.1 Mock Game Server
- 定義されたシナリオ（通常プレイ、RMTスマーフィング、レイヤリング等）に基づいて、擬似的なゲームイベントを生成・送信するツール。

### 4.2 Demo Scenarios API
- 開発環境において、特定の状態遷移を即座に再現するためのデバッグ用エンドポイント。

---

## 5. ロードマップ

実装の優先順位とフェーズ定義は [docs/PLAN.md](docs/PLAN.md) を参照してください。
